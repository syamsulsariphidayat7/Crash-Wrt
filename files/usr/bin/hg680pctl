#!/bin/sh

# GPIO pin POWER
PIN_POWER_ON=521
PIN_POWER_OFF=517
# GPIO pin LAN
PIN_LAN_ON=547
PIN_LAN_OFF=548

PID_DIR="/tmp/hg680p_led"

mkdir -p "$PID_DIR"

set_gpio() {
    local pin="$1"
    local val="$2"
    echo "$pin" > /sys/class/gpio/export 2>/dev/null
    echo out > /sys/class/gpio/gpio${pin}/direction 2>/dev/null
    echo "$val" > /sys/class/gpio/gpio${pin}/value
}

stop_mode() {
    local name="$1"
    local pid_file="$PID_DIR/${name}.pid"
    [ -f "$pid_file" ] && kill "$(cat "$pid_file")" 2>/dev/null && rm -f "$pid_file"
}

mode_heart() {
    local pin_on="$1"
    local pin_off="$2"
    while true; do
        set_gpio "$pin_on" 1
        set_gpio "$pin_off" 0
        sleep 0.2
        set_gpio "$pin_on" 0
        set_gpio "$pin_off" 1
        sleep 0.2
        set_gpio "$pin_on" 0
        set_gpio "$pin_off" 0
        sleep 0.4
    done
}

mode_disko_lan() {
    local pin1="$1"
    local pin2="$2"
    while true; do
        # Merah
        set_gpio "$pin1" 0
        set_gpio "$pin2" 1
        sleep 0.1
        # Kuning
        set_gpio "$pin1" 1
        set_gpio "$pin2" 1
        sleep 0.1
        # Hijau
        set_gpio "$pin1" 1
        set_gpio "$pin2" 0
        sleep 0.1
        # Mati
        set_gpio "$pin1" 0
        set_gpio "$pin2" 0
        sleep 0.1
    done
}

start_mode() {
    local name="$1"
    local mode="$2"
    local pin_on="$3"
    local pin_off="$4"
    stop_mode "$name"
    case "$mode" in
        on)
            set_gpio "$pin_on" 1
            set_gpio "$pin_off" 0
            ;;
        off)
            set_gpio "$pin_on" 0
            set_gpio "$pin_off" 1
            ;;
        heart)
            mode_heart "$pin_on" "$pin_off" &
            echo $! > "$PID_DIR/${name}.pid"
            ;;
        disko)
            if [ "$name" = "lan" ]; then
                mode_disko_lan "$pin_on" "$pin_off" &
                echo $! > "$PID_DIR/${name}.pid"
            else
                echo "Mode disko hanya untuk LAN"
            fi
            ;;
        *)
            echo "Usage: $0 {power|lan} {off|on|heart|disko}"
            exit 1
            ;;
    esac
}

case "$1" in
    power)
        start_mode power "$2" "$PIN_POWER_ON" "$PIN_POWER_OFF"
        ;;
    lan)
        start_mode lan "$2" "$PIN_LAN_ON" "$PIN_LAN_OFF"
        ;;
    *)
        echo "Usage: $0 {power|lan} {off|on|heart|disko}"
        exit 1
        ;;
esac